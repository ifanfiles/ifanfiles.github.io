<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>RainViewer Radar + Batas Wilayah + Kontrol Animasi</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100%; }
    .legend {
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      line-height: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .legend img {
      width: 200px;
      display: block;
      margin-top: 4px;
    }
    .controls {
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      text-align: center;
    }
    .controls button {
      margin: 2px;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #1976d2;
      color: white;
    }
    .controls button:hover {
      background: #1565c0;
    }
    .timestamp {
      margin-top: 6px;
      font-size: 14px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Inisialisasi peta
    const map = L.map('map').setView([-7.685, 109.903], 6);

    // Basemap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // ==== Tambahkan batas wilayah dari GeoJSON ====
    fetch("batas_wilayah.geojson")
      .then(res => res.json())
      .then(data => {
        const geoLayer = L.geoJSON(data, {
          style: { color: "red", weight: 2 }
        }).addTo(map);
        map.fitBounds(geoLayer.getBounds());
      });

    // ==== RainViewer ====
    fetch("https://api.rainviewer.com/public/weather-maps.json")
      .then(res => res.json())
      .then(data => {
        const host = data.host;
        const frames = data.radar.past.concat(data.radar.nowcast);
        let frameIndex = frames.length - 1;
        let radarLayer;
        let isPlaying = false;
        let playInterval;

        function showFrame(index) {
          const frame = frames[index];
          const url = `${host}${frame.path}/256/{z}/{x}/{y}/2/1_1.png`;

          if (radarLayer) map.removeLayer(radarLayer);

          radarLayer = L.tileLayer(url, { opacity: 0.6 });
          radarLayer.addTo(map);

          // update timestamp di kontrol
          document.getElementById("timestamp").innerText =
            new Date(frame.time * 1000).toLocaleString();
        }

        function play() {
          if (isPlaying) return;
          isPlaying = true;
          playInterval = setInterval(() => {
            frameIndex = (frameIndex + 1) % frames.length;
            showFrame(frameIndex);
          }, 1000);
        }

        function pause() {
          isPlaying = false;
          clearInterval(playInterval);
        }

        function nextFrame() {
          frameIndex = (frameIndex + 1) % frames.length;
          showFrame(frameIndex);
        }

        function prevFrame() {
          frameIndex = (frameIndex - 1 + frames.length) % frames.length;
          showFrame(frameIndex);
        }

        // Kontrol animasi
        const controls = L.control({ position: "topright" });
        controls.onAdd = function () {
          const div = L.DomUtil.create("div", "controls");
          div.innerHTML = `
            <button id="playBtn">▶ Play</button>
            <button id="pauseBtn">⏸ Pause</button>
            <button id="prevBtn">⏮ Prev</button>
            <button id="nextBtn">⏭ Next</button>
            <div id="timestamp" class="timestamp"></div>
          `;
          return div;
        };
        controls.addTo(map);

        // Event listener tombol
        document.addEventListener("click", (e) => {
          if (e.target && e.target.id === "playBtn") play();
          if (e.target && e.target.id === "pauseBtn") pause();
          if (e.target && e.target.id === "nextBtn") nextFrame();
          if (e.target && e.target.id === "prevBtn") prevFrame();
        });

        // === Legend otomatis RainViewer ===
        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function () {
          const div = L.DomUtil.create("div", "legend");
          div.innerHTML = "<b>Legenda Curah Hujan</b><br>" +
            "<img src='" + host + data.radar.color + "' alt='Legend'>";
          return div;
        };
        legend.addTo(map);

        // tampilkan frame awal
        showFrame(frameIndex);
      });
  </script>
</body>
</html>
