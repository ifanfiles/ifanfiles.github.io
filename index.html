<script>
  const map = L.map('map').setView([-7.685, 109.903], 6); // Jawa Tengah

  // Basemap satelit
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles Â© Esri'
  }).addTo(map);

  let radarLayers = [];
  let currentFrame = 0;
  let playInterval;
  let frames = [];
  const tsElement = document.getElementById("timestamp");
  const slider = document.getElementById("frameSlider");

  function formatTime(utc) {
    const date = new Date(utc * 1000);
    date.setHours(date.getUTCHours() + 7); // WIB
    return date.toLocaleString("id-ID", {
      day: "2-digit", month: "short", year: "numeric",
      hour: "2-digit", minute: "2-digit"
    });
  }

  function showFrame(i) {
    radarLayers.forEach((layer, idx) => {
      layer.setOpacity(idx === i ? 0.7 : 0);
    });
    tsElement.innerText = formatTime(frames[i].time) + (frames[i].forecast ? " (Forecast)" : "");
    slider.value = i;
  }

  // Ambil data radar dari RainViewer
  fetch("https://api.rainviewer.com/public/weather-maps.json")
    .then(res => res.json())
    .then(data => {
      const host = data.host;

      frames = [...data.radar.past, ...data.radar.nowcast];
      slider.max = frames.length - 1;

      frames.forEach(frame => {
        const url = `${host}${frame.path}/256/{z}/{x}/{y}/2/1_1.png`;
        const layer = L.tileLayer(url, { opacity: 0, attribution: "RainViewer.com" });
        radarLayers.push(layer);
        layer.addTo(map);
      });

      showFrame(currentFrame);

      document.getElementById("play").addEventListener("click", () => {
        clearInterval(playInterval);
        playInterval = setInterval(() => {
          currentFrame = (currentFrame + 1) % radarLayers.length;
          showFrame(currentFrame);
        }, 800);
      });

      document.getElementById("stop").addEventListener("click", () => clearInterval(playInterval));

      document.getElementById("next").addEventListener("click", () => {
        clearInterval(playInterval);
        currentFrame = (currentFrame + 1) % radarLayers.length;
        showFrame(currentFrame);
      });

      document.getElementById("prev").addEventListener("click", () => {
        clearInterval(playInterval);
        currentFrame = (currentFrame - 1 + radarLayers.length) % radarLayers.length;
        showFrame(currentFrame);
      });

      slider.addEventListener("input", (e) => {
        clearInterval(playInterval);
        currentFrame = parseInt(e.target.value);
        showFrame(currentFrame);
      });
    });

  // Tambahkan batas wilayah dari file GeoJSON
  fetch("batas_wilayah.geojson")
    .then(res => res.json())
    .then(geojsonData => {
      L.geoJSON(geojsonData, {
        style: {
          color: "yellow",
          weight: 2,
          fillOpacity: 0
        }
      }).addTo(map);
    })
    .catch(err => console.error("Gagal memuat batas wilayah:", err));
</script>
